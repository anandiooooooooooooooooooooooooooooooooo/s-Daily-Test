name: shadow-zap-daily-test

on:
  schedule:
    - cron: '0 0 * * *'
    - cron: '0 3 * * *'
    - cron: '0 6 * * *'
    - cron: '0 9 * * *'
    - cron: '0 12 * * *'
    - cron: '0 15 * * *'
    - cron: '0 18 * * *'
    - cron: '0 21 * * *'
  workflow_dispatch:

jobs:
  zq_core:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: 'zap/initiate'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'zap/identity-setter'
        run: |
          git config user.name "${{ secrets.GIT_USER_NAME }}"
          git config user.email "${{ secrets.GIT_USER_EMAIL }}"

      - name: 'zap/slot-throttler (variable intensity, no Sunday)'
        id: run_decision
        run: |
          DAY_OF_WEEK=$(date +%u)

          # Skip Sundays (7)
          if [ "$DAY_OF_WEEK" -eq 7 ]; then
            echo "ðŸš« Sunday detected. Skipping all activity."
            echo "should_run=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 80% chance to run
          SHOULD_RUN=$((RANDOM % 10 < 8))
          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT

          if [ "$SHOULD_RUN" -eq 0 ]; then
            echo "ðŸ”• Skipping this run."
            exit 0
          fi

          # Intensity distribution
          R=$((RANDOM % 100))

          if [ "$R" -lt 40 ]; then
            LEVEL="light"
          elif [ "$R" -lt 70 ]; then
            LEVEL="mediumlight"
          elif [ "$R" -lt 90 ]; then
            LEVEL="mediumdark"
          else
            LEVEL="darkest"
          fi

          echo "intensity=$LEVEL" >> $GITHUB_OUTPUT
          echo "ðŸ”¥ Intensity level: $LEVEL"

      - name: 'zap/vector-decider'
        if: steps.run_decision.outputs.should_run == '1'
        id: zq_type
        run: |
          INPUT="${{ github.event.inputs.test_action }}"
          if [ -n "$INPUT" ]; then
            case "$INPUT" in
              cmt) echo "action=commit" >> $GITHUB_OUTPUT; exit 0 ;;
              is)  echo "action=issue" >> $GITHUB_OUTPUT; exit 0 ;;
              pr)  echo "action=pull_request" >> $GITHUB_OUTPUT; exit 0 ;;
              *)   echo "Invalid test_action: '$INPUT'. Falling back." ;;
            esac
          fi

          DAY_OF_WEEK=$(date +%u)
          case $DAY_OF_WEEK in
            1) ACTIONS=(commit commit issue) ;;
            2) ACTIONS=(commit commit pull_request) ;;
            3) ACTIONS=(commit commit issue) ;;
            4) ACTIONS=(commit commit pull_request) ;;
            5) ACTIONS=(commit commit issue pull_request) ;;
            6) ACTIONS=(commit commit issue) ;;
            *) ACTIONS=(commit) ;;
          esac

          RANDOM_ACTION=${ACTIONS[$((RANDOM % ${#ACTIONS[@]}))]}
          echo "Selected action: $RANDOM_ACTION"
          echo "action=$RANDOM_ACTION" >> $GITHUB_OUTPUT

      - name: 'zap/datastream-mutator'
        if: steps.zq_type.outputs.action == 'commit' && steps.run_decision.outputs.should_run == '1'
        run: |
          set -e

          rand_str() {
            tr -dc 'A-Za-z0-9' < /dev/urandom 2>/dev/null | head -c "$1"
          }

          git checkout main
          git pull origin main --rebase

          INTENSITY="${{ steps.run_decision.outputs.intensity }}"

          case "$INTENSITY" in
            light)
              TARGET_FOLDERS=2
              FILES_PER_FOLDER=2
              ;;
            mediumlight)
              TARGET_FOLDERS=4
              FILES_PER_FOLDER=4
              ;;
            mediumdark)
              TARGET_FOLDERS=7
              FILES_PER_FOLDER=6
              ;;
            darkest)
              TARGET_FOLDERS=10
              FILES_PER_FOLDER=10
              ;;
            *)
              TARGET_FOLDERS=3
              FILES_PER_FOLDER=3
              ;;
          esac

          BASE_DIR="data_gen"
          mkdir -p "$BASE_DIR"

          for i in $(seq 1 $TARGET_FOLDERS); do
            FOLDER="$BASE_DIR/$(rand_str 3)"
            mkdir -p "$FOLDER"

            for j in $(seq 1 $FILES_PER_FOLDER); do
              FILE="$FOLDER/$(rand_str 5).dat"
              head -c 256 /dev/urandom > "$FILE"
              git add "$FILE"
            done
          done

          COMMIT_MSG=$(rand_str 32)
          git commit -m "$COMMIT_MSG" || echo "No changes to commit"
          git push origin main

      - name: 'zap/anomaly-logger'
        if: steps.zq_type.outputs.action == 'issue' && steps.run_decision.outputs.should_run == '1'
        env:
          GH_TOKEN: ${{ secrets.PAT_GITHUB }}
        run: |
          rand_str() {
            tr -dc 'A-Za-z0-9' < /dev/urandom 2>/dev/null | head -c "$1"
          }

          gh issue create \
            --repo "${{ github.repository }}" \
            --title "$(rand_str 12)" \
            --body "$(rand_str 32)"

      - name: 'zap/delta-proposer'
        if: steps.zq_type.outputs.action == 'pull_request' && steps.run_decision.outputs.should_run == '1'
        env:
          GH_TOKEN: ${{ secrets.PAT_GITHUB }}
        run: |
          set -e

          rand_str() {
            tr -dc 'A-Za-z0-9' < /dev/urandom 2>/dev/urandom 2>/dev/null | head -c "$1"
          }

          git fetch origin
          git checkout main
          git pull origin main --rebase

          git checkout -B main2 main

          FILE="features/$(rand_str 8).rs"
          mkdir -p "$(dirname "$FILE")"
          echo "// Feature @$(date +%s)" > "$FILE"

          git add "$FILE"
          git commit -m "feat: $(rand_str 24)"
          git push origin main2 --force

          gh pr create \
            --repo "${{ github.repository }}" \
            --base main \
            --head main2 \
            --title "$(rand_str 12)" \
            --body "$(rand_str 32)" \
            || true
